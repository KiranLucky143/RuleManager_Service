<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title>Rule Sets - RuleManager</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; background-color: #f9fafb; color: #222; }
        h1 { margin-bottom: 16px; }
        table { margin-top: 16px; }
        .modal.show { display: block; }
        .overlay.show { display:block; }
        .msg { margin-top:8px; padding:8px; border-radius:4px; display:none; }
        .msg.error { background:#fdecea; color:#611; }
        .msg:not(.error) { background:#e7f3ff; color:#124; }
    </style>
</head>
<body class="container py-4">
<h1 class="text-primary mb-4">Rule Sets</h1>

<div class="d-flex justify-content-between align-items-center mb-3">
    <div>
        <button class="btn btn-primary me-2" id="btnNew">Create Rule Set</button>
        <button class="btn btn-outline-secondary" id="btnRefresh">Refresh</button>
    </div>
    <small class="text-muted">Manage rule sets, upload rule files, publish and map to objects.</small>
</div>

<table id="rulesetTable" class="table table-hover table-bordered align-middle shadow-sm" aria-live="polite">
    <thead class="table-light">
    <tr>
        <th>ID</th>
        <th>Name</th>
        <th>Description</th>
        <th>Version</th>
        <th>Status</th>
        <th>Actions</th>
    </tr>
    </thead>
    <tbody></tbody>
</table>

<div id="message" class="msg"></div>

<!-- Create RuleSet Modal -->
<div id="modalCreate" class="modal fade show" tabindex="-1" role="dialog" aria-modal="true" style="display:none;">
    <div class="modal-dialog">
        <div class="modal-content shadow">
            <div class="modal-header">
                <h5 id="modalTitle" class="modal-title">Create Rule Set</h5>
                <button type="button" class="btn-close" id="btnCloseCreate"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Name</label>
                    <input type="text" id="rsName" class="form-control" />
                </div>
                <div class="mb-3">
                    <label class="form-label">Description</label>
                    <textarea id="rsDesc" class="form-control" rows="3"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="btnCancelCreate">Cancel</button>
                <button class="btn btn-primary" id="btnSaveCreate">Save</button>
            </div>
        </div>
    </div>
</div>

<!-- Upload Rule File Modal -->
<div id="modalUpload" class="modal fade show" tabindex="-1" role="dialog" aria-modal="true" style="display:none;">
    <div class="modal-dialog">
        <div class="modal-content shadow">
            <div class="modal-header">
                <h5 class="modal-title">Upload Rule File</h5>
                <button type="button" class="btn-close" id="btnCloseUpload"></button>
            </div>
            <div class="modal-body">
                <div class="text-muted mb-2">Ruleset: <b id="uploadRulesetName"></b></div>
                <div class="mb-3">
                    <label class="form-label">Choose file (.drl, .dmn, .xlsx)</label>
                    <input type="file" id="uploadFile" class="form-control" />
                </div>
                <div class="mb-3">
                    <label class="form-label">Order Index (optional)</label>
                    <input type="text" id="uploadOrder" class="form-control" placeholder="0" />
                </div>
                <div id="uploadMsg" class="msg"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="btnCancelUpload">Cancel</button>
                <button class="btn btn-primary" id="btnDoUpload">Upload</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Ruleset Modal -->
<div id="modalEdit" class="modal fade show" tabindex="-1" role="dialog" aria-modal="true" style="display:none;">
    <div class="modal-dialog">
        <div class="modal-content shadow">
            <div class="modal-header">
                <h5 class="modal-title">Edit Rule Set</h5>
                <button type="button" class="btn-close" id="btnCloseEdit"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Name</label>
                    <input type="text" id="editRsName" class="form-control" />
                </div>
                <div class="mb-3">
                    <label class="form-label">Description</label>
                    <textarea id="editRsDesc" class="form-control" rows="3"></textarea>
                </div>
                <div class="mb-3">
                    <label class="form-label">Status</label>
                    <select id="editRsStatus" class="form-select">
                        <option value="DRAFT">DRAFT</option>
                        <option value="PUBLISHED">PUBLISHED</option>
                    </select>
                </div>
                <div id="editMsg" class="msg"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="btnCancelEdit">Cancel</button>
                <button class="btn btn-primary" id="btnSaveEdit">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<div id="overlay" class="overlay"></div>

<script>
    const apiBase = '';
    let currentEditRulesetId = null;
    let currentUploadRulesetId = null;

    function showMsg(text, isError=false) {
        const el = document.getElementById('message');
        el.innerText = text;
        el.className = isError ? 'msg error' : 'msg';
        el.style.display = 'block';
        setTimeout(()=> el.style.display = 'none', 4000);
    }

    function showModal(mod){ document.getElementById(mod).style.display='block'; document.getElementById('overlay').classList.add('show'); }
    function hideModal(mod){ document.getElementById(mod).style.display='none'; document.getElementById('overlay').classList.remove('show'); }

    async function fetchRuleSets(){
        try{
            const res=await fetch(apiBase+'/api/rulesets');
            const tbody=document.querySelector('#rulesetTable tbody');
            if(!res.ok){tbody.innerHTML='<tr><td colspan="6" class="text-danger text-center">Error loading</td></tr>';return;}
            const arr=await res.json();
            tbody.innerHTML='';
            arr.forEach(rs=>{
                const tr=document.createElement('tr');
                tr.innerHTML=`
                <td>${rs.id}</td>
                <td>${escapeHtml(rs.name||'')}</td>
                <td>${escapeHtml(rs.description||'')}</td>
                <td>${rs.version||1}</td>
                <td><span class="badge ${rs.status==='PUBLISHED'?'bg-success':'bg-secondary'}">${rs.status||'DRAFT'}</span></td>
                <td class="text-nowrap">
                    <button class="btn btn-sm btn-outline-info me-1" data-action="upload" data-id="${rs.id}" data-name="${escapeAttr(rs.name||'')}">Upload</button>
                    <button class="btn btn-sm btn-outline-warning me-1" data-action="publish" data-id="${rs.id}">Publish</button>
                    <!-- Hidden Map button -->
                    <button class="btn btn-sm btn-outline-secondary me-1 d-none" data-action="map" data-id="${rs.id}" data-name="${escapeAttr(rs.name||'')}">Map</button>
                    <button class="btn btn-sm btn-outline-primary me-1" data-action="viewrules" data-id="${rs.id}">View Rules</button>
                    <button class="btn btn-sm btn-outline-dark me-1" data-action="edit" data-id="${rs.id}" data-name="${escapeAttr(rs.name||'')}" data-desc="${escapeAttr(rs.description||'')}" data-status="${escapeAttr(rs.status||'DRAFT')}">Edit</button>
                    <button class="btn btn-sm btn-outline-danger" data-action="delete" data-id="${rs.id}" data-name="${escapeAttr(rs.name||'')}">Delete</button>
                </td>`;
                tbody.appendChild(tr);
            });
        }catch(e){showMsg('Failed: '+e.message,true);}
    }

    function escapeHtml(s){return String(s).replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));}
    function escapeAttr(s){return escapeHtml(s).replace(/'/g,'&#39;');}

    document.getElementById('btnRefresh').addEventListener('click',fetchRuleSets);
    document.getElementById('btnNew').addEventListener('click',()=>showModal('modalCreate'));

    // ===== NEW: Create ruleset handler (added) =====
    document.getElementById('btnSaveCreate').addEventListener('click', async ()=>{
        const name = document.getElementById('rsName').value.trim();
        const desc = document.getElementById('rsDesc').value.trim();
        if(!name){ alert('Name required'); return; }
        try{
            const res = await fetch(apiBase + '/api/rulesets', {
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body: JSON.stringify({ name, description: desc })
            });
            if(!res.ok){
                showMsg('Create failed: ' + await res.text(), true);
                return;
            }
            hideModal('modalCreate');
            showMsg('Ruleset created');
            fetchRuleSets();
        }catch(e){
            showMsg('Create failed: ' + e.message, true);
        }
    });

    // close/cancel for create/upload/edit
    document.getElementById('btnCloseCreate').addEventListener('click', ()=> hideModal('modalCreate'));
    document.getElementById('btnCancelCreate').addEventListener('click', ()=> hideModal('modalCreate'));
    document.getElementById('btnCloseUpload').addEventListener('click', ()=> hideModal('modalUpload'));
    document.getElementById('btnCancelUpload').addEventListener('click', ()=> hideModal('modalUpload'));
    document.getElementById('btnCloseEdit').addEventListener('click', ()=> hideModal('modalEdit'));
    document.getElementById('btnCancelEdit').addEventListener('click', ()=> hideModal('modalEdit'));

    document.querySelector('#rulesetTable tbody').addEventListener('click',async ev=>{
        const btn=ev.target.closest('button');if(!btn)return;
        const action=btn.dataset.action,id=btn.dataset.id,name=btn.dataset.name;

        if(action==='upload'){
            // ===== CHANGED: open upload modal & prep state =====
            currentUploadRulesetId = id;
            document.getElementById('uploadRulesetName').innerText = name || id;
            const fi = document.getElementById('uploadFile'); if (fi) fi.value = '';
            const oi = document.getElementById('uploadOrder'); if (oi) oi.value = '0';
            const um = document.getElementById('uploadMsg'); if (um) { um.innerText=''; um.style.display='none'; }
            showModal('modalUpload');
        }
        else if(action==='publish'){publishRuleset(id);}
        else if(action==='viewrules'){window.location.href='/rulesets/'+id+'/files-ui';}
        else if(action==='edit'){
            currentEditRulesetId=id;
            document.getElementById('editRsName').value=btn.dataset.name||'';
            document.getElementById('editRsDesc').value=btn.dataset.desc||'';
            document.getElementById('editRsStatus').value=(btn.dataset.status||'DRAFT').toUpperCase();
            document.getElementById('editMsg').style.display='none';
            showModal('modalEdit');
        }
        else if(action==='delete'){deleteRuleset(id,name);}
    });

    async function publishRuleset(id){
        if(!confirm('Publish ruleset id='+id+'?'))return;
        try{
            const res=await fetch(apiBase+'/api/rulesets/'+id+'/publish',{method:'POST'});
            if(!res.ok){showMsg('Publish failed: '+await res.text(),true);return;}
            showMsg('Published');fetchRuleSets();
        }catch(e){showMsg('Error: '+e.message,true);}
    }

    async function deleteRuleset(id,name){
        if(!confirm('Delete ruleset "'+(name||id)+'"?'))return;
        try{
            const res=await fetch(apiBase+'/api/rulesets/'+id,{method:'DELETE'});
            if(!res.ok){showMsg('Delete failed: '+await res.text(),true);return;}
            showMsg('Deleted');fetchRuleSets();
        }catch(e){showMsg('Error: '+e.message,true);}
    }

    // ===== NEW: Upload submit handler (added) =====
    document.getElementById('btnDoUpload').addEventListener('click', async ()=>{
        const fileInput = document.getElementById('uploadFile');
        if(!fileInput || !fileInput.files || fileInput.files.length===0){ alert('Choose a file'); return; }
        const file = fileInput.files[0];
        const order = document.getElementById('uploadOrder').value || '0';
        const fd = new FormData();
        fd.append('file', file);
        fd.append('orderIndex', order);
        try{
            const res = await fetch(apiBase + '/api/rulesets/' + currentUploadRulesetId + '/files', { method:'POST', body: fd });
            const m = document.getElementById('uploadMsg');
            if(!res.ok){
                m.innerText = 'Upload failed: ' + (await res.text());
                m.className = 'msg error';
                m.style.display='block';
                return;
            }
            m.innerText = 'Upload successful';
            m.className = 'msg';
            m.style.display='block';
            setTimeout(()=>{ hideModal('modalUpload'); fetchRuleSets(); }, 800);
        }catch(e){
            const m = document.getElementById('uploadMsg');
            m.innerText = 'Upload failed: ' + e.message;
            m.className = 'msg error';
            m.style.display='block';
        }
    });

    document.getElementById('btnSaveEdit').addEventListener('click',async ()=>{
        const name=document.getElementById('editRsName').value.trim();
        const desc=document.getElementById('editRsDesc').value.trim();
        const status=(document.getElementById('editRsStatus').value||'DRAFT').toUpperCase();
        if(!name){alert('Name required');return;}
        try{
            const res=await fetch(apiBase+'/api/rulesets/'+currentEditRulesetId+'/update',{
                method:'POST',headers:{'Content-Type':'application/json'},
                body:JSON.stringify({name,description:desc,status})
            });
            const em=document.getElementById('editMsg');
            if(!res.ok){em.innerText='Update failed: '+await res.text();em.className='msg error';em.style.display='block';return;}
            em.innerText='Updated successfully';em.className='msg';em.style.display='block';
            setTimeout(()=>{hideModal('modalEdit');fetchRuleSets();},800);
        }catch(e){const em=document.getElementById('editMsg');em.innerText='Error: '+e.message;em.className='msg error';em.style.display='block';}
    });

    fetchRuleSets();
</script>
</body>
</html>
